# chatbot_citas_sqlite_fixed.py - Chatbot corregido para Streamlit Cloud
import streamlit as st
import datetime
import re
from datetime import datetime, timedelta, date
# from database import DatabaseManager  # Comentado temporalmente para deployment

# Configuraci√≥n de la p√°gina
st.set_page_config(
    page_title="Asistente Virtual - Cl√≠nica MediCare",
    page_icon="üè•",
    layout="centered"
)

# CSS mejorado y corregido
st.markdown("""
<style>
    .main-header {
        text-align: center;
        color: #2E86AB;
        padding: 1rem 0;
        margin-bottom: 1rem;
    }
    .subtitle {
        text-align: center;
        color: #666;
        font-style: italic;
        margin-bottom: 2rem;
    }
    .status-success {
        background-color: #d4edda;
        border-left: 4px solid #28a745;
        padding: 15px;
        margin: 15px 0;
        border-radius: 5px;
        color: #155724;
    }
    .status-warning {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 15px;
        margin: 15px 0;
        border-radius: 5px;
        color: #856404;
    }
    .appointment-summary {
        background-color: #e3f2fd;
        border: 1px solid #2196f3;
        padding: 20px;
        margin: 15px 0;
        border-radius: 10px;
    }
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1rem;
        border-radius: 10px;
        color: white;
        margin: 0.5rem 0;
        text-align: center;
    }
    .stButton > button {
        width: 100%;
    }
</style>
""", unsafe_allow_html=True)

# Mock Database para deployment (reemplazar con tu DatabaseManager real)
class MockDatabaseManager:
    def __init__(self):
        self.servicios = [
            {'id': 1, 'nombre': 'Consulta General', 'precio': 500, 'duracion': 30, 'medico': 'Dr. Rodr√≠guez', 'medico_id': 1},
            {'id': 2, 'nombre': 'Pediatr√≠a', 'precio': 600, 'duracion': 45, 'medico': 'Dr. Garc√≠a', 'medico_id': 2},
            {'id': 3, 'nombre': 'Cardiolog√≠a', 'precio': 800, 'duracion': 60, 'medico': 'Dra. Mart√≠nez', 'medico_id': 3},
            {'id': 4, 'nombre': 'Dermatolog√≠a', 'precio': 700, 'duracion': 30, 'medico': 'Dr. L√≥pez', 'medico_id': 4},
            {'id': 5, 'nombre': 'Laboratorio', 'precio': 250, 'duracion': 15, 'medico': 'QFB Angel Carrizalez', 'medico_id': 5}
        ]
    
    def obtener_servicios(self):
        return self.servicios
    
    def obtener_horarios_disponibles(self, fecha):
        # Simulaci√≥n de horarios disponibles
        horarios = ["09:00", "09:30", "10:00", "10:30", "11:00", "11:30", 
                   "12:00", "12:30", "14:00", "14:30", "15:00", "15:30"]
        return horarios[:6]  # Simular algunos horarios ocupados
    
    def crear_cita(self, **kwargs):
        # Simular creaci√≥n exitosa
        numero_confirmacion = f"MC{datetime.now().strftime('%Y%m%d%H%M%S')}"
        return {
            'success': True,
            'numero_confirmacion': numero_confirmacion,
            'mensaje': 'Cita creada exitosamente'
        }
    
    def cancelar_cita(self, numero_confirmacion):
        # Simular cancelaci√≥n
        if numero_confirmacion.startswith('MC'):
            return {
                'success': True,
                'mensaje': 'Cita cancelada exitosamente'
            }
        else:
            return {
                'success': False,
                'mensaje': 'N√∫mero de confirmaci√≥n no v√°lido'
            }

# Inicializar base de datos con manejo de errores
@st.cache_resource
def init_database():
    try:
        # return DatabaseManager()  # Descomenta cuando tengas el m√≥dulo database
        return MockDatabaseManager()  # Temporal para deployment
    except Exception as e:
        st.error(f"Error conectando a la base de datos: {e}")
        return MockDatabaseManager()

# Inicializaci√≥n segura de la base de datos
if 'db' not in st.session_state:
    st.session_state.db = init_database()

db = st.session_state.db

# T√≠tulo y descripci√≥n
st.markdown('<h1 class="main-header">üè• Asistente Virtual Inteligente - Cl√≠nica MediCare</h1>', unsafe_allow_html=True)
st.markdown('<p class="subtitle">Sistema de citas con base de datos SQLite y gesti√≥n avanzada</p>', unsafe_allow_html=True)

# Inicializar el estado de la sesi√≥n de forma segura
if "messages" not in st.session_state:
    st.session_state.messages = [
        {"role": "assistant", "content": """¬°Bienvenido al Sistema Inteligente de Citas de Cl√≠nica MediCare! üè•

Soy tu asistente virtual con **base de datos SQLite** en tiempo real.

**üéØ ¬øC√≥mo puedo ayudarte?**
‚Ä¢ üìÖ **Agendar cita** con confirmaci√≥n autom√°tica
‚Ä¢ üí∞ **Consultar precios** y servicios especializados  
‚Ä¢ üïí **Verificar disponibilidad** en tiempo real
‚Ä¢ üìã **Buscar tu cita** por nombre o tel√©fono
‚Ä¢ ‚ùå **Cancelar cita** con n√∫mero de confirmaci√≥n
‚Ä¢ üîÑ **Cambiar/reagendar cita** existente
‚Ä¢ üö® Informaci√≥n de **contacto y emergencias**

**‚ú® Nuevas caracter√≠sticas:**
‚Ä¢ üóÑÔ∏è **Base de datos SQLite** local y confiable
‚Ä¢ üîÑ **Sincronizaci√≥n instant√°nea** con el panel m√©dico
‚Ä¢ üìä **Gesti√≥n avanzada** de horarios y servicios
‚Ä¢ üÜî **N√∫meros de confirmaci√≥n** √∫nicos
‚Ä¢ üë®‚Äç‚öïÔ∏è **Panel m√©dico** integrado para doctores

**üí° Ejemplos de uso:**
- "Quiero agendar una cita de cardiolog√≠a para ma√±ana"
- "Juan P√©rez, 3312345678, consulta general, viernes"
- "¬øCu√°nto cuesta una consulta de pediatr√≠a?"
- "Cancelar cita MC20241220145230"
- "Cambiar cita MC20241220145230 para el mi√©rcoles"

¬øEn qu√© puedo ayudarte hoy?"""}
    ]

if "user_data" not in st.session_state:
    st.session_state.user_data = {}

if "processing" not in st.session_state:
    st.session_state.processing = False

# Funciones auxiliares mejoradas y optimizadas
def detectar_intencion(mensaje):
    """Detecta la intenci√≥n del usuario con an√°lisis mejorado"""
    if not mensaje or len(mensaje.strip()) == 0:
        return "saludo"
    
    mensaje_lower = mensaje.lower()
    
    # NUEVO: Detectar cambio/reagendar cita
    if any(palabra in mensaje_lower for palabra in ["cambiar", "reagendar", "mover", "cambio"]):
        if re.search(r'mc\d+', mensaje_lower):
            return "cambiar_cita"
        else:
            return "solicitar_cambio"
    
    # Detectar cancelaci√≥n de cita
    if any(palabra in mensaje_lower for palabra in ["cancelar", "cancela", "eliminar"]):
        if re.search(r'mc\d+', mensaje_lower):
            return "cancelar_cita"
        else:
            return "solicitar_cancelacion"
    
    # Detectar b√∫squeda de cita existente
    if any(palabra in mensaje_lower for palabra in ["buscar", "encontrar", "mi cita", "cita de"]):
        return "buscar_cita"
    
    # Detectar informaci√≥n completa de cita
    try:
        tiene_telefono = bool(re.search(r'\b\d{10}\b|\b\d{2}[-\s]?\d{4}[-\s]?\d{4}\b', mensaje))
        tiene_servicio = any(servicio.lower() in mensaje_lower for servicio in get_servicios_nombres())
        tiene_nombre = len([p for p in mensaje.split() if p.isalpha() and len(p) > 2]) >= 2
        
        if tiene_telefono and (tiene_servicio or tiene_nombre):
            return "procesar_cita_completa"
    except Exception:
        pass
    
    if any(palabra in mensaje_lower for palabra in ["cita", "agendar", "reservar", "turno", "consulta"]):
        return "agendar_cita"
    elif any(palabra in mensaje_lower for palabra in ["precio", "costo", "cuanto", "tarifa"]):
        return "precios_servicios"
    elif any(palabra in mensaje_lower for palabra in ["horario", "hora", "abierto", "cerrado", "disponible"]) and "cita" not in mensaje_lower:
        return "horarios_disponibles"
    elif any(palabra in mensaje_lower for palabra in ["emergencia", "urgente", "dolor", "accidente", "grave"]):
        return "emergencia"
    elif any(palabra in mensaje_lower for palabra in ["hola", "buenos", "buenas", "saludos", "ayuda"]):
        return "saludo"
    else:
        return "informacion_general"

def get_servicios_nombres():
    """Obtiene nombres de servicios disponibles de forma segura"""
    try:
        servicios = db.obtener_servicios()
        return [s['nombre'] for s in servicios]
    except Exception:
        return ["Consulta General", "Pediatr√≠a", "Cardiolog√≠a", "Dermatolog√≠a", "Laboratorio"]

def generar_respuesta_servicios_limpia():
    """Genera lista de servicios con formato limpio"""
    try:
        servicios = db.obtener_servicios()
        
        servicios_texto = ""
        for servicio in servicios:
            nombre = servicio['nombre']
            precio = int(servicio.get('precio', 0))
            duracion = servicio.get('duracion', 30)
            medico = servicio.get('medico', 'No asignado')
            
            # Emoji espec√≠fico para laboratorio
            if nombre.lower() == 'laboratorio':
                emoji = "üß™"
            else:
                emoji = "‚ú®"
            
            # Formato limpio sin caracteres especiales
            servicios_texto += f"{emoji} **{nombre}** - ${precio} MXN ({duracion} min) - {medico}\n"
        
        return servicios_texto
        
    except Exception as e:
        # Fallback con servicios fijos y formato limpio
        return """‚ú® **Consulta General** - $500 MXN (30 min) - Dr. Rodr√≠guez
‚ú® **Pediatr√≠a** - $600 MXN (45 min) - Dr. Garc√≠a
‚ú® **Cardiolog√≠a** - $800 MXN (60 min) - Dra. Mart√≠nez
‚ú® **Dermatolog√≠a** - $700 MXN (30 min) - Dr. L√≥pez  
üß™ **Laboratorio** - $250 MXN (15 min) - QFB Angel Carrizalez
"""

def manejar_cambio_cita(mensaje):
    """Maneja el cambio/reagendamiento de citas existentes"""
    # Extraer n√∫mero de confirmaci√≥n
    match = re.search(r'mc\d+', mensaje.lower())
    if not match:
        return """‚ùå **CAMBIAR CITA**
        
Para cambiar una cita necesito el **n√∫mero de confirmaci√≥n**.

**üìã Formato:** MC20241220145230

**üí° Ejemplo:** "Cambiar cita MC20241220145230 para el mi√©rcoles"

**¬øNo tienes el n√∫mero?** Puedo buscarte la cita por tu nombre."""
    
    numero_confirmacion = match.group().upper()
    
    # Buscar d√≠a nuevo en el mensaje
    mensaje_lower = mensaje.lower()
    dias_variantes = {
        'lunes': ['lunes', 'lun'],
        'martes': ['martes', 'mar'], 
        'miercoles': ['miercoles', 'mi√©rcoles', 'mie'],
        'jueves': ['jueves', 'jue'],
        'viernes': ['viernes', 'vie'],
        'sabado': ['sabado', 's√°bado', 'sab']
    }
    
    dia_nuevo = None
    for dia_base, variantes in dias_variantes.items():
        if any(variante in mensaje_lower for variante in variantes):
            dia_nuevo = dia_base
            break
    
    if not dia_nuevo:
        return f"""üìÖ **CAMBIAR CITA: {numero_confirmacion}**
        
Para cambiar tu cita necesito saber **a qu√© d√≠a** quieres moverla.

{obtener_disponibilidad_proximos_dias()}

**üí° Ejemplo:** "Cambiar a mi√©rcoles" o "Mover para el viernes"

**¬øQu√© d√≠a prefieres?**"""
    
    # Verificar disponibilidad del d√≠a nuevo
    try:
        fecha_nueva = obtener_fecha_desde_dia(dia_nuevo)
        horarios_disponibles = db.obtener_horarios_disponibles(fecha_nueva)
        
        if not horarios_disponibles:
            return f"""‚ùå **SIN DISPONIBILIDAD PARA {dia_nuevo.upper()}**
            
{obtener_disponibilidad_proximos_dias()}

**¬øTe parece bien otro d√≠a?**"""
        
        # Simular cambio exitoso 
        return f"""‚úÖ **CITA CAMBIADA EXITOSAMENTE**

**üìã DETALLES DEL CAMBIO:**

üÜî **Confirmaci√≥n:** {numero_confirmacion}
üóìÔ∏è **Nuevo d√≠a:** {dia_nuevo.title()}
üìÖ **Nueva fecha:** {fecha_nueva}
‚è∞ **Nueva hora:** {horarios_disponibles[0]}

**‚ö†Ô∏è IMPORTANTE:**
‚Ä¢ Tu n√∫mero de confirmaci√≥n **sigue siendo el mismo**
‚Ä¢ Llegar **15 minutos antes** de la nueva hora
‚Ä¢ Para cancelar: usa el mismo n√∫mero de confirmaci√≥n

**¬°Cambio confirmado! üëç**"""
    
    except Exception as e:
        return "‚ùå Error al procesar el cambio de cita. Intenta nuevamente."

def generar_respuesta(mensaje, intencion):
    """Genera respuestas inteligentes basadas en la intenci√≥n detectada"""
    
    try:
        # NUEVO CASO: Cambiar cita
        if intencion == "cambiar_cita":
            return manejar_cambio_cita(mensaje)
        
        elif intencion == "solicitar_cambio":
            return """üìÖ **CAMBIAR/REAGENDAR CITA EXISTENTE**

Para cambiar tu cita necesito el **n√∫mero de confirmaci√≥n**.

**üìã Formato:** MC20241220145230

**üí° Ejemplos:**
‚Ä¢ "Cambiar cita MC20241220145230 para el mi√©rcoles"
‚Ä¢ "Reagendar MC20241220145230 al viernes"
‚Ä¢ "Mover mi cita MC20241220145230 para el lunes"

**¬øNo tienes el n√∫mero?** Puedo buscarte la cita por tu nombre."""
        
        elif intencion == "cancelar_cita":
            # Extraer n√∫mero de confirmaci√≥n
            match = re.search(r'mc\d+', mensaje.lower())
            if match:
                numero_confirmacion = match.group().upper()
                resultado = db.cancelar_cita(numero_confirmacion=numero_confirmacion)
                
                if resultado['success']:
                    return f"""‚úÖ **CITA CANCELADA EXITOSAMENTE**

üìã **Confirmaci√≥n:** {numero_confirmacion}
‚úÖ **Estado:** Cancelada correctamente
üìÖ **Fecha de cancelaci√≥n:** {datetime.now().strftime('%d/%m/%Y %H:%M')}

**¬øDeseas agendar una nueva cita?** Solo dime cu√°ndo te gustar√≠a venir."""
                else:
                    return f"""‚ùå **ERROR AL CANCELAR**

üîç **N√∫mero buscado:** {numero_confirmacion}
‚ùå **Problema:** {resultado['mensaje']}

**üí° Verifica:**
‚Ä¢ Que el n√∫mero sea correcto
‚Ä¢ Que la cita no haya sido cancelada previamente
‚Ä¢ Que el n√∫mero tenga formato: MC20241220145230

**¬øNecesitas ayuda?** Puedo buscarte la cita por tu nombre."""
        
        elif intencion == "solicitar_cancelacion":
            return """‚ùå **CANCELAR CITA EXISTENTE**

Para cancelar tu cita necesito el **n√∫mero de confirmaci√≥n** que recibiste al agendar.

**üìã Formato del n√∫mero:** MC20241220145230

**üí° Si no lo tienes, puedo buscarte la cita:**
‚Ä¢ Dime tu nombre completo
‚Ä¢ O tu n√∫mero de tel√©fono
‚Ä¢ O dime "buscar mi cita"

**Ejemplo:** "Cancelar cita MC20241220145230" """
        
        elif intencion == "buscar_cita":
            return """üîç **BUSCAR CITA EXISTENTE**

Para buscar tu cita necesito:

**1Ô∏è‚É£ Opci√≥n 1 - Por nombre completo:**
"Buscar cita de Juan P√©rez Garc√≠a"

**2Ô∏è‚É£ Opci√≥n 2 - Por tel√©fono:**
"Buscar cita 3312345678"

**3Ô∏è‚É£ Opci√≥n 3 - Por n√∫mero de confirmaci√≥n:**
"Mi cita es MC20241220145230"

**¬øCu√°l prefieres usar?**"""
        
        elif intencion == "procesar_cita_completa":
            return procesar_cita_completa(mensaje)
        
        elif intencion == "agendar_cita":
            servicios_texto = generar_respuesta_servicios_limpia()
            
            return f"""üìÖ **AGENDAR NUEVA CITA**

**üìù Para agendar en un solo mensaje, incluye:**
1. **Nombre completo**
2. **Tel√©fono** (10 d√≠gitos)  
3. **Servicio** que necesitas
4. **D√≠a preferido** (lunes, martes, etc.)

**üè• SERVICIOS DISPONIBLES:**
{servicios_texto}

**üí° Ejemplo perfecto:**
*"Mar√≠a Gonz√°lez L√≥pez, 3312345678, pediatr√≠a, mi√©rcoles"*

**üìÖ Tambi√©n acepto formatos como:**
- "Consulta general para Juan P√©rez, tel 33-1234-5678, prefiero viernes"
- "Agendar cardiolog√≠a, soy Ana Silva, 3312345678, cualquier d√≠a de la semana"

¬°Tu cita ser√° procesada autom√°ticamente! ‚ö°"""
        
        elif intencion == "precios_servicios":
            try:
                servicios = db.obtener_servicios()
                
                servicios_texto = ""
                for servicio in servicios:
                    precio = int(servicio.get('precio', 0))
                    nombre = servicio['nombre']
                    servicios_texto += f"‚Ä¢ **{nombre}**: ${precio} MXN\n"
                    
            except Exception as e:
                servicios_texto = """‚Ä¢ **Consulta General**: $500 MXN
‚Ä¢ **Pediatr√≠a**: $600 MXN
‚Ä¢ **Cardiolog√≠a**: $800 MXN
‚Ä¢ **Dermatolog√≠a**: $700 MXN
‚Ä¢ **Laboratorio**: $250 MXN"""
            
            return f"""üí∞ **TARIFAS CL√çNICA MEDICARE 2024**

{servicios_texto}

**üí≥ FORMAS DE PAGO ACEPTADAS:**
‚Ä¢ üíµ Efectivo
‚Ä¢ üí≥ Tarjetas de d√©bito/cr√©dito
‚Ä¢ üè¶ Transferencias bancarias
‚Ä¢ üè• Seguros m√©dicos mayores*

*Consulta cobertura espec√≠fica

**üí° Los precios incluyen:**
‚úÖ Consulta m√©dica completa
‚úÖ Diagn√≥stico profesional  
‚úÖ Receta m√©dica (si aplica)
‚úÖ Seguimiento post-consulta

**üß™ Servicios de laboratorio** incluyen an√°lisis b√°sicos y entrega de resultados.

**¬øListo para agendar?** Solo dime el servicio que necesitas."""
        
        elif intencion == "horarios_disponibles":
            # Obtener disponibilidad de los pr√≥ximos d√≠as
            disponibilidad_texto = obtener_disponibilidad_proximos_dias()
            
            return f"""üïí **HORARIOS Y DISPONIBILIDAD**

**üìÖ HORARIOS GENERALES:**
‚Ä¢ **Lunes a Viernes:** 9:00 AM - 6:00 PM
‚Ä¢ **S√°bados:** 9:00 AM - 11:30 AM  
‚Ä¢ **Domingos:** Solo emergencias

{disponibilidad_texto}

**‚ö†Ô∏è INFORMACI√ìN IMPORTANTE:**
‚Ä¢ Citas cada 30 minutos
‚Ä¢ Llegar 15 min antes de la cita
‚Ä¢ √öltima cita: 30 min antes del cierre

**¬øQuieres agendar una cita?** Solo d√≠melo."""
        
        elif intencion == "emergencia":
            return """üö® **PROTOCOLO DE EMERGENCIAS**

**üìû EMERGENCIAS M√âDICAS 24/7:**
**(33) 1234-5678** 

**üè• Cl√≠nica MediCare - Emergencias**
üìç Av. Principal #123, Guadalajara, Jalisco

**‚ö° EN CASO DE EMERGENCIA GRAVE:**

1. **üìû Llama INMEDIATAMENTE** al n√∫mero de emergencias
2. **üè• Acude** al hospital m√°s cercano si es necesario
3. **üë®‚Äç‚öïÔ∏è Contacta** a tu m√©dico de cabecera si es posible

**üöë N√öMEROS DE EMERGENCIA NACIONAL:**
‚Ä¢ **Cruz Roja:** 065
‚Ä¢ **Emergencias Generales:** 911
‚Ä¢ **Bomberos:** 911

**‚ö†Ô∏è IMPORTANTE:** Si es una emergencia real, no uses este chat. Llama directamente."""
        
        elif intencion == "saludo":
            return """üëã **¬°Hola! Bienvenido a Cl√≠nica MediCare**

Soy tu asistente virtual inteligente con **base de datos avanzada**. 

**üéØ Estoy aqu√≠ para ayudarte con:**

‚Ä¢ üìÖ **Agendar citas** - Proceso autom√°tico e instant√°neo
‚Ä¢ üîç **Buscar tus citas** - Por nombre, tel√©fono o n√∫mero
‚Ä¢ ‚ùå **Cancelar citas** - Con tu n√∫mero de confirmaci√≥n
‚Ä¢ üîÑ **Cambiar/reagendar citas** - F√°cil y r√°pido
‚Ä¢ üí∞ **Consultar precios** - Tarifas actualizadas 2024
‚Ä¢ ‚è∞ **Ver disponibilidad** - Horarios en tiempo real
‚Ä¢ üö® **Emergencias** - Informaci√≥n de contacto inmediato

**üí° Tip:** Puedo procesar tu cita en un solo mensaje si me das todos los datos juntos.

**¬øEn qu√© te ayudo hoy?** üòä"""
        
        else:
            try:
                servicios_count = len(db.obtener_servicios())
            except:
                servicios_count = 5  # Fallback
            
            return f"""‚ÑπÔ∏è **CL√çNICA MEDICARE - INFORMACI√ìN GENERAL**

üè• **Somos especialistas en atenci√≥n m√©dica integral** con sistema digitalizado de √∫ltima generaci√≥n.

**üéØ NUESTRO SISTEMA:**
‚Ä¢ üóÑÔ∏è **Base de datos SQLite** confiable y r√°pida
‚Ä¢ ‚ö° **Procesamiento autom√°tico** de citas
‚Ä¢ üìä **Panel m√©dico** integrado para doctores
‚Ä¢ üÜî **N√∫meros √∫nicos** de confirmaci√≥n
‚Ä¢ üîÑ **Sincronizaci√≥n en tiempo real**

**üíº SERVICIOS M√âDICOS:**
‚Ä¢ {servicios_count} especialidades m√©dicas disponibles
‚Ä¢ M√©dicos certificados y especializados
‚Ä¢ Equipos de diagn√≥stico modernos
‚Ä¢ Seguimiento post-consulta incluido

**üí° PREGUNTAS FRECUENTES:**
‚Ä¢ *"¬øCu√°nto cuesta una consulta?"* ‚Üí Consultar precios
‚Ä¢ *"¬øQu√© horarios tienen disponibles?"* ‚Üí Ver disponibilidad
‚Ä¢ *"Quiero agendar una cita"* ‚Üí Proceso autom√°tico
‚Ä¢ *"Buscar mi cita"* ‚Üí B√∫squeda inteligente
‚Ä¢ *"Cambiar mi cita"* ‚Üí Reagendar f√°cilmente

**¬øHay algo espec√≠fico en lo que pueda ayudarte?**"""
    
    except Exception as e:
        return """‚ùå **Error procesando tu solicitud**

Por favor, intenta nuevamente o reformula tu mensaje.

**¬øPuedo ayudarte con algo espec√≠fico como:**
‚Ä¢ Agendar una cita
‚Ä¢ Consultar precios
‚Ä¢ Ver horarios disponibles

**üí° Tambi√©n puedes escribir "ayuda" para ver todas las opciones."""

def procesar_cita_completa(mensaje):
    """Procesa una cita con toda la informaci√≥n proporcionada"""
    
    try:
        # Extraer datos del mensaje
        datos = extraer_datos_mensaje(mensaje)
        
        if not datos.get('nombre'):
            return "‚ùå No pude identificar el nombre completo. Por favor, especif√≠calo claramente."
        
        if not datos.get('telefono'):
            return "‚ùå No encontr√© un n√∫mero de tel√©fono v√°lido. Debe tener 10 d√≠gitos."
        
        if not datos.get('servicio_id'):
            servicios_texto = generar_respuesta_servicios_limpia()
            return f"""‚ùå **No identifiqu√© el servicio m√©dico solicitado.**

**üè• Servicios disponibles:**
{servicios_texto}

**Por favor especifica cu√°l necesitas.**"""
        
        # Buscar d√≠a disponible
        if datos.get('dia_preferido'):
            fecha_preferida = obtener_fecha_desde_dia(datos['dia_preferido'])
            horarios_disponibles = db.obtener_horarios_disponibles(fecha_preferida)
            
            if not horarios_disponibles:
                return f"""‚ùå **Sin disponibilidad para {datos['dia_preferido'].title()}**

{obtener_disponibilidad_proximos_dias()}

üí° **¬øTe parece bien otro d√≠a?** Solo d√≠melo."""
            
            # Agendar la cita
            resultado = db.crear_cita(
                paciente_nombre=datos['nombre'],
                paciente_telefono=datos['telefono'],
                servicio_id=datos['servicio_id'],
                medico_id=datos['medico_id'],
                fecha=fecha_preferida,
                hora=horarios_disponibles[0]
            )
            
            if resultado['success']:
                # Obtener informaci√≥n del servicio
                servicios = db.obtener_servicios()
                servicio_info = next((s for s in servicios if s['id'] == datos['servicio_id']), {})
                
                return f"""‚úÖ **¬°CITA CONFIRMADA Y GUARDADA!**

**üìã RESUMEN COMPLETO:**

üë§ **Paciente:** {datos['nombre']}
üìû **Tel√©fono:** {datos['telefono']}
üè• **Servicio:** {servicio_info.get('nombre', '')}
üë®‚Äç‚öïÔ∏è **M√©dico:** {servicio_info.get('medico', '')}

üóìÔ∏è **D√≠a:** {datos['dia_preferido'].title()}
üìÖ **Fecha:** {fecha_preferida}
‚è∞ **Hora:** {horarios_disponibles[0]}
‚è±Ô∏è **Duraci√≥n:** {servicio_info.get('duracion', 30)} minutos
üí∞ **Costo:** ${servicio_info.get('precio', 0):.0f} MXN

**üÜî N√öMERO DE CONFIRMACI√ìN:**
**{resultado['numero_confirmacion']}**

üìç **Ubicaci√≥n:** Cl√≠nica MediCare
Av. Principal #123, Guadalajara, Jalisco

**‚ö†Ô∏è RECORDATORIOS IMPORTANTES:**
‚Ä¢ Llegar **15 minutos antes** de tu cita
‚Ä¢ Traer **identificaci√≥n oficial**
‚Ä¢ Para cancelar: usa tu n√∫mero de confirmaci√≥n
‚Ä¢ Reagendar: con **24h de anticipaci√≥n**

**üìû ¬øDudas?** Llama al (33) 1234-5678

**¬°Nos vemos pronto! üëã**"""
            else:
                return f"‚ùå **Error al agendar la cita:** {resultado.get('mensaje', 'Error desconocido')}"
        
        else:
            return f"""üìù **Datos recibidos correctamente:**

‚úÖ **Nombre:** {datos['nombre']}
‚úÖ **Tel√©fono:** {datos['telefono']}
‚úÖ **Servicio:** Identificado

üóìÔ∏è **Falta especificar el d√≠a preferido:**

{obtener_disponibilidad_proximos_dias()}

**üí° Solo dime qu√© d√≠a prefieres y completar√© tu cita.**"""
    
    except Exception as e:
        return "‚ùå Error procesando los datos de la cita. Por favor, intenta nuevamente con el formato sugerido."

def extraer_datos_mensaje(mensaje):
    """Extrae informaci√≥n detallada del mensaje para agendar cita - VERSI√ìN CORREGIDA"""
    datos = {}
    
    try:
        # Buscar tel√©fono
        telefono_patterns = [
            r'\b(\d{10})\b',
            r'\b(\d{2}[-\s]?\d{4}[-\s]?\d{4})\b',
            r'\b(\d{3}[-\s]?\d{3}[-\s]?\d{4})\b'
        ]
        
        for pattern in telefono_patterns:
            match = re.search(pattern, mensaje)
            if match:
                datos['telefono'] = match.group().replace('-', '').replace(' ', '')
                break
        
        # Buscar servicio y obtener su ID
        servicios = db.obtener_servicios()
        mensaje_lower = mensaje.lower()
        
        for servicio in servicios:
            nombre_servicio = servicio['nombre'].lower()
            if nombre_servicio in mensaje_lower:
                datos['servicio_id'] = servicio['id']
                datos['medico_id'] = servicio.get('medico_id', 1)
                break
        
        # Buscar d√≠as
        dias_variantes = {
            'lunes': ['lunes', 'lun'],
            'martes': ['martes', 'mar'],
            'miercoles': ['miercoles', 'mi√©rcoles', 'mie'],
            'jueves': ['jueves', 'jue'],
            'viernes': ['viernes', 'vie'],
            'sabado': ['sabado', 's√°bado', 'sab']
        }
        
        for dia_base, variantes in dias_variantes.items():
            if any(variante in mensaje_lower for variante in variantes):
                datos['dia_preferido'] = dia_base
                break
        
        # CORRECCI√ìN CR√çTICA: Mejorar extracci√≥n de nombres
        # Limpiar el mensaje primero
        mensaje_limpio = mensaje.replace(',', ' ').replace('tel', '').replace('tel√©fono', '')
        
        # Remover n√∫meros de tel√©fono del texto para extracci√≥n de nombres
        for pattern in telefono_patterns:
            mensaje_limpio = re.sub(pattern, '', mensaje_limpio)
        
        # Palabras a ignorar en la extracci√≥n de nombres
        palabras_ignore = {
            'para', 'con', 'del', 'una', 'cita', 'agendar', 'consulta', 'soy', 
            'general', 'laboratorio', 'cardiolog√≠a', 'pediatr√≠a', 'dermatolog√≠a',
            'prefiero', 'cualquier', 'd√≠a', 'semana', 'lunes', 'martes', 
            'mi√©rcoles', 'miercoles', 'jueves', 'viernes', 's√°bado', 'sabado', 'domingo'
        }
        
        # Extraer nombres (solo palabras alfab√©ticas que no sean palabras a ignorar)
        palabras = mensaje_limpio.split()
        nombres = []
        
        for palabra in palabras:
            palabra_clean = palabra.strip('.,!?;:').title()
            if (palabra_clean.isalpha() and 
                len(palabra_clean) > 2 and 
                palabra_clean.lower() not in palabras_ignore):
                nombres.append(palabra_clean)
            
            if len(nombres) >= 4:  # M√°ximo 4 nombres (nombre + apellidos)
                break
        
        # Filtrar nombres m√°s inteligentemente
        if nombres:
            # Si hay muchos nombres, tomar solo los primeros 3-4
            if len(nombres) > 4:
                nombres = nombres[:4]
            
            # Verificar que no sean palabras extra√±as
            nombres_validos = []
            for nombre in nombres:
                # Solo nombres que tengan al menos 3 caracteres y sean alfab√©ticos
                if len(nombre) >= 3 and nombre.isalpha() and nombre.lower() not in palabras_ignore:
                    nombres_validos.append(nombre)
            
            if nombres_validos:
                datos['nombre'] = ' '.join(nombres_validos)
    
    except Exception as e:
        # En caso de error, devolver datos vac√≠os
        pass
    
    return datos

def obtener_fecha_desde_dia(dia_nombre):
    """Convierte nombre de d√≠a a fecha de la pr√≥xima semana"""
    try:
        dias_semana = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo']
        
        if dia_nombre.lower() not in dias_semana:
            return None
        
        hoy = date.today()
        dia_objetivo = dias_semana.index(dia_nombre.lower())
        dias_hasta_objetivo = (dia_objetivo - hoy.weekday()) % 7
        
        if dias_hasta_objetivo == 0:  # Es hoy, buscar la pr√≥xima semana
            dias_hasta_objetivo = 7
        
        fecha_objetivo = hoy + timedelta(days=dias_hasta_objetivo)
        return fecha_objetivo.strftime("%Y-%m-%d")
    except Exception:
        return None

def obtener_disponibilidad_proximos_dias():
    """Genera texto con disponibilidad de los pr√≥ximos 7 d√≠as"""
    try:
        texto = "üìÖ **DISPONIBILIDAD PR√ìXIMOS D√çAS:**\n\n"
        dias_semana = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo']
        
        hoy = date.today()
        
        for i in range(7):
            fecha_check = hoy + timedelta(days=i+1)
            dia_nombre = dias_semana[fecha_check.weekday()]
            
            # Saltar domingos
            if dia_nombre == 'domingo':
                continue
                
            horarios = db.obtener_horarios_disponibles(fecha_check.strftime("%Y-%m-%d"))
            count = len(horarios)
            
            fecha_str = fecha_check.strftime("%d/%m")
            
            if count > 5:
                status = f"‚úÖ **{count} horarios** disponibles"
            elif count > 0:
                status = f"‚ö†Ô∏è **Solo {count} horarios** disponibles"
            else:
                status = "‚ùå **Sin disponibilidad**"
            
            texto += f"‚Ä¢ **{dia_nombre.title()}** ({fecha_str}): {status}\n"
        
        return texto
    except Exception:
        return "üìÖ **DISPONIBILIDAD:** Consultar horarios disponibles"

# Funciones para mostrar en chat de forma segura
def mostrar_mensaje_usuario(mensaje):
    """Muestra mensaje del usuario de forma segura"""
    try:
        with st.chat_message("user"):
            st.markdown(mensaje)
    except Exception:
        st.error("Error mostrando mensaje del usuario")

def mostrar_mensaje_asistente(respuesta):
    """Muestra mensaje del asistente de forma segura"""
    try:
        with st.chat_message("assistant"):
            st.markdown(respuesta)
    except Exception:
        st.error("Error mostrando respuesta del asistente")

# Mostrar historial de mensajes de forma segura
try:
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])
except Exception as e:
    st.error("Error mostrando el historial de mensajes")

# Campo de entrada del chat con manejo de errores mejorado
if prompt := st.chat_input("üí¨ Escribe tu mensaje aqu√≠..."):
    # Evitar procesamiento duplicado
    if not st.session_state.processing:
        st.session_state.processing = True
        
        try:
            # Agregar mensaje del usuario
            st.session_state.messages.append({"role": "user", "content": prompt})
            
            # Mostrar mensaje del usuario
            mostrar_mensaje_usuario(prompt)
            
            # Detectar intenci√≥n y generar respuesta
            with st.chat_message("assistant"):
                with st.spinner("ü§ñ Procesando con IA y consultando base de datos..."):
                    try:
                        intencion = detectar_intencion(prompt)
                        respuesta = generar_respuesta(prompt, intencion)
                        st.markdown(respuesta)
                        
                        # Agregar respuesta al historial
                        st.session_state.messages.append({"role": "assistant", "content": respuesta})
                        
                    except Exception as e:
                        error_msg = """‚ùå **Error procesando tu solicitud**

Lo siento, hubo un problema t√©cnico. Por favor:

‚Ä¢ **Intenta nuevamente** con tu mensaje
‚Ä¢ **Reformula** tu pregunta de otra manera
‚Ä¢ **Usa comandos simples** como "agendar cita" o "ver precios"

**üí° Si persiste el problema:**
Recarga la p√°gina y vuelve a intentarlo."""
                        
                        st.markdown(error_msg)
                        st.session_state.messages.append({"role": "assistant", "content": error_msg})
        
        finally:
            # Restablecer el flag de procesamiento
            st.session_state.processing = False

# Sidebar mejorado con manejo de errores
with st.sidebar:
    st.header("üè• Cl√≠nica MediCare")
    
    # Estado de la base de datos con manejo seguro
    try:
        servicios_count = len(db.obtener_servicios())
        st.markdown(f"""
        <div class="status-success">
            <strong>‚úÖ Sistema Conectado</strong><br>
            <small>{servicios_count} servicios disponibles</small>
        </div>
        """, unsafe_allow_html=True)
    except Exception:
        st.markdown("""
        <div class="status-warning">
            <strong>‚ö†Ô∏è Modo de demostraci√≥n</strong><br>
            <small>Usando datos de prueba</small>
        </div>
        """, unsafe_allow_html=True)
    
    # Panel de control r√°pido
    st.subheader("‚ö° Acceso R√°pido")
    
    col1, col2 = st.columns(2)
    
    with col1:
        if st.button("ü©∫ Panel", use_container_width=True):
            st.info("Panel m√©dico disponible por separado")
    
    with col2:
        if st.button("üìä Stats", use_container_width=True):
            try:
                fecha_hoy = date.today().strftime("%Y-%m-%d")
                total_servicios = len(db.obtener_servicios())
                
                st.markdown(f"""
                <div class="metric-card">
                    <h4>üìà Estad√≠sticas</h4>
                    <p>üè• Servicios: {total_servicios}</p>
                    <p>üìÖ Fecha: {fecha_hoy}</p>
                    <p>ü§ñ Estado: Activo</p>
                </div>
                """, unsafe_allow_html=True)
            except Exception:
                st.error("Error cargando estad√≠sticas")
    
    st.markdown("---")
    
    # Informaci√≥n de contacto
    st.subheader("üìû Contacto")
    st.write("**üì± Principal:** (33) 1234-5678")
    st.write("**üí¨ WhatsApp:** (33) 1234-5678")  
    st.write("**üìß Email:** citas@medicare.com")
    
    st.subheader("üìç Ubicaci√≥n")
    st.write("Av. Principal #123")
    st.write("Guadalajara, Jalisco, M√©xico")
    st.write("CP: 44100")
    
    st.subheader("üïí Horarios")
    st.write("**Lunes - Viernes:** 9:00 AM - 6:00 PM")
    st.write("**S√°bados:** 9:00 AM - 11:30 AM") 
    st.write("**Domingos:** Solo emergencias")
    
    st.markdown("---")
    
    # Herramientas de administraci√≥n
    st.subheader("üîß Herramientas")
    
    col1, col2 = st.columns(2)
    with col1:
        if st.button("üóëÔ∏è Limpiar", use_container_width=True):
            try:
                st.session_state.messages = [st.session_state.messages[0]]
                st.session_state.user_data = {}
                st.session_state.processing = False
                st.rerun()
            except Exception:
                st.error("Error al limpiar")
    
    with col2:
        if st.button("üîÑ Actualizar", use_container_width=True):
            try:
                st.cache_resource.clear()
                st.session_state.processing = False
                st.rerun()
            except Exception:
                st.error("Error al actualizar")
    
    # Informaci√≥n de la sesi√≥n actual (solo si hay datos)
    if st.session_state.user_data:
        st.subheader("üë§ Datos de Sesi√≥n")
        try:
            for key, value in st.session_state.user_data.items():
                st.write(f"**{key.title()}:** {value}")
        except Exception:
            st.write("Error mostrando datos de sesi√≥n")
    
    # Ayuda r√°pida
    with st.expander("üí° Ayuda R√°pida"):
        st.markdown("""
        **üéØ Ejemplos de uso:**
        
        ‚Ä¢ **Agendar:** "Juan P√©rez, 3312345678, cardiolog√≠a, viernes"
        
        ‚Ä¢ **Cancelar:** "Cancelar MC20241220145230"
        
        ‚Ä¢ **Cambiar:** "Cambiar MC20241220145230 para mi√©rcoles"
        
        ‚Ä¢ **Buscar:** "Buscar mi cita Juan P√©rez"
        
        ‚Ä¢ **Precios:** "¬øCu√°nto cuesta pediatr√≠a?"
        """)

# Footer actualizado
st.markdown("---")
st.markdown(
    """
    <div style='text-align: center; color: #666; font-size: 12px; padding: 10px;'>
    üè• <strong>Cl√≠nica MediCare</strong> - Sistema Inteligente de Gesti√≥n de Citas v2.1<br>
    üóÑÔ∏è Powered by SQLite Database | ü§ñ Asistente Virtual Avanzado | üë®‚Äç‚öïÔ∏è Panel M√©dico Integrado<br>
    ‚ú® Funciones: Agendar ‚Ä¢ Cancelar ‚Ä¢ Cambiar ‚Ä¢ Buscar ‚Ä¢ Consultar Precios
    </div>
    """, 
    unsafe_allow_html=True
)